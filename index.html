<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/styles.css">
  </head>
  <body>
    <div id="finder">
      <ul id="list-files">
        
      </ul>
      <button id="play">Play</button>
    </div>
    <div id="timeline">
      <div class="pistes-container">
        <div class="piste"></div>
        <div class="piste"></div>
        <div class="piste"></div>
        <div class="piste"></div>
      </div>
    </div>
  </body>

  <script src="js/jquery.js"></script>
  <script src="js/jquery-ui.min.js"></script>
  <script src="js/ressources.js"></script>
  <script src="js/Timeline.js"></script>
  <script src="js/Song.js"></script>
  <script>
    
    var timeline=new Timeline();

    for (var i = 0; i < ressources.length; i++) {
      $('#list-files').append('<li class="file-path">'+ressources[i]+'</li>');
    };
    var audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    $('.file-path').click(function(event){
        var url=$(this).html();
        request = new XMLHttpRequest();
        request.open('GET', url, true);
        request.responseType = 'arraybuffer';

        request.onload = function() {
          audioCtx.decodeAudioData(request.response, function(buffer)
          {
            var source;
            source=audioCtx.createBufferSource();
            source.buffer=buffer;
            source.connect(audioCtx.destination);
            source.start();
          },function(e){"Error with decoding audio data" + e.err});
        }
        request.send();
    });
    
    
    $('li').draggable(
      {
        helper: "clone"
      }
    );

    $('.piste').droppable({
        drop: function( event, ui ) 
        {
          if(ui.draggable.context.localName=="li"){
            var song=new Song();
            song.loadSongFromUrl(ui.draggable.html());
            timeline.songs.push(song);
            song.viewBox=$('<div class="box">');
            $(this).append(song.viewBox);
          }
          else{
            $(ui.draggable.context).css('top','0px');
            $(ui.draggable.context).css('position','absolute');
            $(this).append($(ui.draggable.context));
          }
        }
      }
    );

    allSources=[];

    function playSound(buffer, time) {
      var source = audioCtx.createBufferSource();
      source.buffer = buffer;
      source.connect(audioCtx.destination);
      source.start(time);
      return source;
    }



    $('#play').click(function(event){
      console.log('test');

      for(var x in allSources)
      {
        allSources[x].stop();
      }
      allSources=[];

      for(var x in timeline.songs)
      {
        
        for (var x in timeline.songs) {

          var song=timeline.songs[x];
          console.log(song.getDebut());

          allSources.push(playSound(song.buffer,audioCtx.currentTime+song.getDebut()));
        };
        
      }

    })

  </script>
</html>
